<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" th:replace="fragments :: layout(~{::body})">
<body>
<section>
    <h2 class="text-2xl sm:text-3xl font-semibold tracking-tight text-brand mb-2">초대권 수령</h2>
    <p class="text-sm text-brand/60 mb-4">초대한 연주자의 이름을 입력하고 확인을 눌러주세요.</p>

    <!-- 연주자 이름 입력 + 확인 버튼 -->
    <div class="flex gap-2">
        <input id="pf" type="text" placeholder="초대한 연주자의 이름을 입력해주세요"
               class="w-full rounded-xl ring-1 ring-brand/15 px-4 py-3 focus:outline-none focus:ring-brand/30" />
        <button id="pfCheckBtn"
                class="shrink-0 rounded-lg bg-brand px-4 py-2 text-white font-medium hover:bg-brand/90 transition">
            확인
        </button>
    </div>
    <p id="warn" class="hidden text-sm text-red-600 mt-2">연주자 이름을 다시 한 번 입력해주세요.</p>

    <!-- 구분선: 이름 영역과 아래 폼 분리 -->
    <div class="my-4 h-px bg-brand/10"></div>

    <!-- 아래 영역은 확인 전까지 숨김 -->
    <div id="afterArea" class="hidden">
        <p class="text-sm text-brand/60 mb-5">대표 수령을 선택하면 2행부터는 이름만 입력하면 됩니다.</p>
        <label id="repLabel" class="hidden items-center gap-2 text-sm text-brand/80">
            <input id="repCheck" type="checkbox" class="h-4 w-4 rounded border-brand/30 text-brand focus:ring-brand/30">
             대표 수령
        </label>
        <div id="form" class="space-y-3"></div>
        <!-- ✅ 개인정보 제공 동의 -->
        <label class="inline-flex items-start gap-2 text-sm text-brand/80 select-none mt-4">
            <input id="consentChk" type="checkbox"
                   class="mt-1 h-4 w-4 rounded border-brand/30 text-brand focus:ring-brand/30">
            <span>
            초대권 수령을 위해
            <button type="button" class="underline underline-offset-2 hover:text-brand" onclick="openConsent()">개인정보 제공</button>
            에 동의합니다.
            </span>
        </label>
        <br>
        <label class="inline-flex items-start gap-2 text-sm text-brand/80 select-none mt-4">
            <input id="policyChk" type="checkbox"
                   class="mt-1 h-4 w-4 rounded border-brand/30 text-brand focus:ring-brand/30">
            <span>
            초대권 수령을 위해
            <button type="button" class="underline underline-offset-2 hover:text-brand" onclick="openPolicy()">서비스 이용약관</button>
            에 동의합니다.
            </span>
        </label>
        <div class="mt-5 flex items-center justify-between">
            <div class="ml-auto">
                <button id="submitBtn" disabled
                        class="inline-flex items-center rounded-lg bg-brand px-4 py-2 text-white font-medium hover:bg-brand/90 transition opacity-50 cursor-not-allowed"
                        onclick="onSubmit()">
                    응모하기
                </button>
            </div>
        </div>
    </div>

    <div class="mt-6 text-center">
        <a class="text-sm text-brand/60 hover:text-brand" href="/">메인으로</a>
    </div>
</section>

<!-- ✅ 개인정보 제공 안내 모달 -->
<div id="consentModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60" onclick="closeConsent()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="w-full max-w-xl rounded-2xl bg-white shadow-card ring-1 ring-black/10">
            <div class="px-6 py-5">
                <h3 class="text-lg font-semibold text-brand mb-3">개인정보 제공 안내</h3>
                <!-- ✅ 작성한 HTML을 그대로 로드 -->
                <iframe id="privacyFrame" src="/legal/privacy.html" class="w-full h-[calc(80vh-52px)] border-0"></iframe>
                <div class="mt-5 flex justify-end gap-2">
                    <button type="button" class="px-4 py-2 rounded-lg ring-1 ring-brand/15 text-brand/80 hover:bg-brand/5"
                            onclick="closeConsent()">닫기</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="policyModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60" onclick="closePolicy()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
        <div class="w-full max-w-xl rounded-2xl bg-white shadow-card ring-1 ring-black/10">
            <div class="px-6 py-5">
                <h3 class="text-lg font-semibold text-brand mb-3">서비스 이용약관</h3>
                <!-- ✅ 작성한 HTML을 그대로 로드 -->
                <iframe id="policyFrame" src="/legal/terms.html" class="w-full h-[calc(80vh-52px)] border-0"></iframe>
                <div class="mt-5 flex justify-end gap-2">
                    <button type="button" class="px-4 py-2 rounded-lg ring-1 ring-brand/15 text-brand/80 hover:bg-brand/5"
                            onclick="closePolicy()">닫기</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script th:inline="javascript">
    let performers = /*[[${performers}]]*/ [];
    const pf = document.getElementById('pf');
    const warn = document.getElementById('warn');
    const form = document.getElementById('form');
    const repLabel = document.getElementById('repLabel');
    const repCheck = document.getElementById('repCheck');

    let rows = [{name:'', email:'', phone:''}];
    let rep = false;
      let verified = false;

      // 확인 버튼 클릭 또는 Enter 시 1회 검증
      pfCheckBtn.addEventListener('click', checkPerformer);
      pf.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') { e.preventDefault(); checkPerformer(); } });

      function checkPerformer(){
        const name = (pf.value||'').trim().toLowerCase();
        const ok = performers.some(p => (p.name||'').toLowerCase() === name);
        if(ok){
          verified = true;
          warn.classList.add('hidden');
          afterArea.classList.remove('hidden');
          pf.setAttribute('disabled','disabled');
          pf.classList.add('bg-gray-100','cursor-not-allowed');
          pfCheckBtn.setAttribute('disabled','disabled');
          pfCheckBtn.classList.add('opacity-60','cursor-not-allowed');
          // 폼 초기 렌더 및 포커스
          render();
          // 첫 번째 입력에 포커스
          const firstInput = form.querySelector('input[type="text"]');
          if(firstInput) firstInput.focus();
        }else{
          verified = false;
          warn.classList.remove('hidden');
          afterArea.classList.add('hidden');
        }
      }

    const consentChk = document.getElementById('consentChk');
    const policyChk = document.getElementById('policyChk');
    const submitBtn  = document.getElementById('submitBtn');

    consentChk.addEventListener('change', syncSubmitState);
    policyChk.addEventListener('change', syncSubmitState);

    function syncSubmitState(){
      const enabled = !!consentChk.checked && !!policyChk.checked;
      submitBtn.disabled = !enabled;
      submitBtn.classList.toggle('opacity-50', !enabled);
      submitBtn.classList.toggle('cursor-not-allowed', !enabled);
    }
    function openConsent(){
        document.getElementById('consentModal').classList.remove('hidden');
        document.documentElement.classList.add('overflow-hidden'); // 배경 스크롤 잠금
    }
    function closeConsent(){
        document.getElementById('consentModal').classList.add('hidden');
        document.documentElement.classList.remove('overflow-hidden');
    }

    function openPolicy(){
        document.getElementById('policyModal').classList.remove('hidden');
        document.documentElement.classList.add('overflow-hidden'); // 배경 스크롤 잠금
    }
    function closePolicy(){
        document.getElementById('policyModal').classList.add('hidden');
        document.documentElement.classList.remove('overflow-hidden');
    }

    repCheck.addEventListener('change', (e)=>{ rep = e.target.checked; render(); });

    function controlBtn(html){ return `<button class="px-3 py-2 rounded-lg ring-1 ring-brand/15 text-brand/80 hover:bg-brand/5">${html}</button>`; }

    function render(){
      form.innerHTML = '';
      rows.forEach((r,i)=>{
        const ro = (rep && i>0);

        const card = document.createElement('div');
        card.className = 'relative lib-card p-4 md:p-5';

        // 2번째 카드부터 우상단 '−'
        if(i>0){
          const del = document.createElement('button');
          del.type = 'button';
          del.className = 'lib-close';
          del.setAttribute('aria-label','참석자 삭제');
          del.title = '참석자 삭제';
          del.textContent = 'x';
          del.onclick = ()=>removeRow(i);
          card.appendChild(del);
        }

        // 카드 본문 (그리드 인풋)
        const inner = document.createElement('div');
        inner.className = 'grid grid-cols-1 md:grid-cols-12 gap-3 items-start';
        inner.innerHTML = `
          <div class="lib-label col-span-12">참석자 ${i+1}</div>

          <input type="text" placeholder="이름" value="${r.name||''}"
                 class="lib-input col-span-12 md:col-span-4"
                 oninput="onE(${i},'name',this.value)" aria-label="이름">

          <input type="email" placeholder="이메일" value="${r.email||''}" ${ro?'disabled':''}
                 class="lib-input col-span-12 md:col-span-4 ${ro?'bg-gray-100 cursor-not-allowed':''}"
                 oninput="onE(${i},'email',this.value)" aria-label="이메일">

          <input type="tel" placeholder="전화번호" value="${r.phone||''}" ${ro?'disabled':''}
                 class="lib-input col-span-12 md:col-span-4 ${ro?'bg-gray-100 cursor-not-allowed':''}"
                 oninput="onE(${i},'phone',this.value)" aria-label="전화번호">
        `;
        card.appendChild(inner);
        form.appendChild(card);
      });

      // + 참석자 추가 (행 아래에 한 번만)
      const addBox = document.createElement('button');
      addBox.type = 'button';
      addBox.className = 'lib-addbox mt-3';
      addBox.textContent = '+ 참석자 추가';
      addBox.onclick = addRow;
      form.appendChild(addBox);

      // 대표 수령 토글 노출
      repLabel.classList.toggle('hidden', rows.length < 2);
      repCheck.checked = rep;
    }

    function onE(i,k,v){
      // 전화번호일 때 자동 하이픈 처리
      if(k === 'phone'){
        v = formatPhone(v);
        renderPhoneValue(i, v);
      }
      rows[i][k] = v;
    }

    // 전화번호 포맷터: 숫자만 남기고 010-xxxx-xxxx 형태로 변환
    function formatPhone(value){
      const num = value.replace(/[^0-9]/g, ''); // 숫자만 남김
      if(num.length <= 3) return num;
      if(num.length <= 7) return num.replace(/(\d{3})(\d+)/, '$1-$2');
      return num.replace(/(\d{3})(\d{4})(\d{0,4})/, '$1-$2-$3').replace(/-$/, '');
    }

    // 입력 필드 값 즉시 갱신 (렌더 없이)
    function renderPhoneValue(index, value){
      const inputs = form.querySelectorAll('input[type="tel"]');
      if(inputs[index]) inputs[index].value = value;
    }

    function addRow(){ rows.push({name:'', email:'', phone:''}); render(); }
    function removeRow(i){ rows.splice(i,1); if(rows.length<2) rep=false; render(); }

    function isValidEmail(email){
      return /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}$/.test(email);
    }
    function isValidPhone(phone){
      return /^010-\d{4}-\d{4}$/.test(phone);
    }

    async function onSubmit(){
      if(submitBtn.disabled) return;            // 동의 전 클릭 방지
      if(!consentChk.checked){ alert('개인정보 제공에 동의해 주세요.'); return; }
      for(let i=0;i<rows.length;i++){
        const r=rows[i];
        if(!r.name.trim()){
          alert(`${i+1}번째 행: 이름을 입력하세요.`); return;
        }
        if(!(rep && i>0)){ // 대표수령 제외
          if(!isValidEmail(r.email||'')){
            alert(`${i+1}번째 행: 이메일 형식이 올바르지 않습니다.`); return;
          }
          if(!isValidPhone(r.phone||'')){
            alert(`${i+1}번째 행: 전화번호는 010-xxxx-xxxx 형식이어야 합니다.`); return;
          }
        }
      }
      const name = pf.value.trim();
      if(!confirm(`총 ${rows.length}명 맞으신가요? 기재주신 연락처로 알림 메일 발송됩니다.`)) return;
      const body = { domainType:'INVITE', performerName:name, isRepDelivery:rep, members:rows, consentAgreed:true };
      const res = await fetch('/api/applications',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if(res.ok){
        alert('초대권 신청이 정상적으로 완료되었습니다.\n확인 메일 및 문자가 발송되었으니, 문자나 메일을 수신하지 못하신 경우 스팸함 확인하신 후 스팸해제 진행 부탁드립니다.');
        location.href='/';
      } else {
        alert('오류: ' + await res.text());
      }
    }

    render();
    syncSubmitState(); // ✅ 초기 비활성 상태 반영
</script>
</body>
</html>
