<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" th:replace="fragments :: layout(~{::body})">
<body>
<section>
    <h2 class="text-2xl sm:text-3xl font-semibold tracking-tight text-brand mb-2">초대권 수령</h2>
    <p class="text-sm text-brand/60 mb-4">초대한 연주자의 이름을 입력하면 다음 단계로 진행됩니다.</p>

    <input id="pf" type="text" placeholder="초대한 연주자의 이름을 입력해주세요"
           class="w-full rounded-xl ring-1 ring-brand/15 px-4 py-3 focus:outline-none focus:ring-brand/30 mb-2" />
    <p id="warn" class="hidden text-sm text-red-600 mb-4">연주자 이름을 다시 한 번 입력해주세요.</p>

    <div id="form" class="hidden space-y-3"></div>

    <div class="mt-5 flex items-center justify-between">
        <label id="repLabel" class="hidden items-center gap-2 text-sm text-brand/80">
            <input id="repCheck" type="checkbox" class="h-4 w-4 rounded border-brand/30 text-brand focus:ring-brand/30">
            대표 수령
        </label>
        <div class="ml-auto">
            <button class="inline-flex items-center rounded-lg bg-brand px-4 py-2 text-white font-medium hover:bg-brand/90 transition"
                    onclick="onSubmit()">
                응모하기
            </button>
        </div>
    </div>

    <div class="mt-6 text-center">
        <a class="text-sm text-brand/60 hover:text-brand" href="/">메인으로</a>
    </div>
</section>

<script th:inline="javascript">
    let performers = /*[[${performers}]]*/ [];
    const pf = document.getElementById('pf');
    const warn = document.getElementById('warn');
    const form = document.getElementById('form');
    const repLabel = document.getElementById('repLabel');
    const repCheck = document.getElementById('repCheck');

    let rows = [{name:'', email:'', phone:''}];
    let rep = false;

    repCheck.addEventListener('change', (e)=>{ rep = e.target.checked; render(); });

    pf.addEventListener('input', ()=>{
      const name = pf.value.trim().toLowerCase();
      const ok = performers.some(p => (p.name||'').toLowerCase() === name);
      form.classList.toggle('hidden', !ok);
      warn.classList.toggle('hidden', !(name && !ok));
    });

    function controlBtn(html){ return `<button class="px-3 py-2 rounded-lg ring-1 ring-brand/15 text-brand/80 hover:bg-brand/5">${html}</button>`; }

    function render(){
      form.innerHTML = '';
      rows.forEach((r,i)=>{
        const ro = (rep && i>0);
        const row = document.createElement('div');
row.className = 'grid grid-cols-1 md:grid-cols-12 gap-3 items-start';

        row.innerHTML = `
          <!-- 이름 -->
          <input type="text" placeholder="이름" value="${r.name||''}"
                 class="w-full min-w-0 col-span-12 md:col-span-4
                        rounded-xl ring-1 ring-brand/15 px-4 py-3 focus:outline-none focus:ring-brand/30"
                 oninput="onE(${i},'name',this.value)" aria-label="이름">

          <!-- 이메일 -->
          <input type="email" placeholder="이메일" value="${r.email||''}" ${ro?'disabled':''}
                 class="w-full min-w-0 col-span-12 md:col-span-4
                        rounded-xl ring-1 ring-brand/15 px-4 py-3 ${ro?'bg-gray-100 cursor-not-allowed':''}
                        focus:outline-none focus:ring-brand/30"
                 oninput="onE(${i},'email',this.value)" aria-label="이메일">

          <!-- 전화번호 -->
          <input type="tel" placeholder="전화번호" value="${r.phone||''}" ${ro?'disabled':''}
                 class="w-full min-w-0 col-span-12 md:col-span-3
                        rounded-xl ring-1 ring-brand/15 px-4 py-3 ${ro?'bg-gray-100 cursor-not-allowed':''}
                        focus:outline-none focus:ring-brand/30"
                 oninput="onE(${i},'phone',this.value)" aria-label="전화번호">

          <!-- 버튼: 모바일은 다음 줄 전폭, md부터 1칸 고정폭 -->
          <div class="col-span-12 md:col-span-1 md:w-[4.5rem] w-full shrink-0
                      flex justify-end gap-2 mt-1 md:mt-0">
            ${i===0
              ? `<button class="w-9 h-10 rounded-lg ring-1 ring-brand/15 text-brand/80 hover:bg-brand/5">+</button>`
              : `<button class="w-9 h-10 rounded-lg ring-1 ring-brand/15 text-brand/80 hover:bg-brand/5">+</button>
                 <button class="w-9 h-10 rounded-lg ring-1 ring-brand/15 text-brand/80 hover:bg-brand/5">−</button>`}
          </div>
        `;
        form.appendChild(row);
        const btns = row.querySelectorAll('button');
        btns[0].onclick = addRow;
        if(btns[1]) btns[1].onclick = ()=>removeRow(i);
      });

      repLabel.classList.toggle('hidden', rows.length < 2);
      repCheck.checked = rep;
    }

    function onE(i,k,v){ rows[i][k]=v; }
    function addRow(){ rows.push({name:'', email:'', phone:''}); render(); }
    function removeRow(i){ rows.splice(i,1); if(rows.length<2) rep=false; render(); }

    function isValidEmail(email){
      return /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}$/.test(email);
    }
    function isValidPhone(phone){
      return /^010-\d{4}-\d{4}$/.test(phone);
    }

    async function onSubmit(){
      for(let i=0;i<rows.length;i++){
        const r=rows[i];
        if(!r.name.trim()){
          alert(`${i+1}번째 행: 이름을 입력하세요.`); return;
        }
        if(!(rep && i>0)){ // 대표수령 제외
          if(!isValidEmail(r.email||'')){
            alert(`${i+1}번째 행: 이메일 형식이 올바르지 않습니다.`); return;
          }
          if(!isValidPhone(r.phone||'')){
            alert(`${i+1}번째 행: 전화번호는 010-xxxx-xxxx 형식이어야 합니다.`); return;
          }
        }
      }
      const name = pf.value.trim();
      if(!confirm(`총 ${rows.length}명 맞으신가요? 기재주신 연락처로 알림 메일 발송됩니다.`)) return;
      const body = { domainType:'INVITE', performerName:name, isRepDelivery:rep, members:rows };
      const res = await fetch('/api/applications',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if(res.ok){
        alert('성공적으로 응모되었습니다!\n10월 25일 토요일에 응모 결과가 기재주신 연락처로 발송예정입니다. 감사합니다.');
        location.href='/';
      } else {
        alert('오류: ' + await res.text());
      }
    }

    render();
</script>
</body>
</html>
