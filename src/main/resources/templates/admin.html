<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" th:replace="fragments :: layout_wide(~{::body})">
<body>
<section>
    <h2 class="text-2xl font-semibold text-brand mb-4">관리자 대시보드</h2>

    <form method="get" class="grid grid-cols-1 md:grid-cols-12 gap-x-3 gap-y-2 mb-4">

        <!-- 1행: 검색어 / 유형 / 상태 -->
        <div class="md:col-span-6 flex flex-col">
            <span class="text-xs text-brand/60 mb-1">검색어</span>
            <input type="text" name="q" placeholder="이름/이메일/전화/연주자 검색" th:value="${q}"
                   class="w-full rounded-xl ring-1 ring-brand/15 px-4 py-2" />
        </div>

        <div class="md:col-span-3 flex flex-col">
            <span class="text-xs text-brand/60 mb-1">유형</span>
            <select name="type" class="w-full rounded-xl ring-1 ring-brand/15 px-3 py-2">
                <option th:selected="${type == null}" value="">전체 유형</option>
                <option th:each="t : ${types}" th:value="${t.name()}" th:selected="${type==t}" th:text="${t.ko()}"></option>
            </select>
        </div>

        <div class="md:col-span-3 flex flex-col">
            <span class="text-xs text-brand/60 mb-1">상태</span>
            <select name="status" class="w-full rounded-xl ring-1 ring-brand/15 px-3 py-2">
                <option th:selected="${status == null}" value="">전체 상태</option>
                <option th:each="s : ${statuses}" th:value="${s.name()}" th:selected="${status==s}" th:text="${s.ko()}"></option>
            </select>
        </div>

        <!-- 2행: 시작/종료/정렬/버튼 -->
        <div class="md:col-span-4 flex flex-col">
            <span class="text-xs text-brand/60 mb-1">시작 시각</span>
            <input type="datetime-local" name="start" th:value="${start}"
                   class="w-full rounded-xl ring-1 ring-brand/15 px-3 py-2" />
        </div>

        <div class="md:col-span-4 flex flex-col">
            <span class="text-xs text-brand/60 mb-1">종료 시각</span>
            <input type="datetime-local" name="end" th:value="${end}"
                   class="w-full rounded-xl ring-1 ring-brand/15 px-3 py-2" />
        </div>

        <div class="md:col-span-2 flex flex-col">
            <span class="text-xs text-brand/60 mb-1">정렬</span>
            <select name="dir" class="w-full rounded-xl ring-1 ring-brand/15 px-3 py-2">
                <option th:selected="${dir == null || dir == 'desc'}" value="desc">최신순</option>
                <option th:selected="${dir == 'asc'}" value="asc">오래된순</option>
            </select>
        </div>


        <!-- ✅ 검색 버튼은 같은 줄(2행) 끝에 위치 -->
        <div class="md:col-span-2 flex items-end">
            <button class="w-full rounded-xl bg-brand text-white px-4 py-2">검색</button>
        </div>

        <!-- ✅ 엑셀다운만 한 칸 아래 (3행 전체) -->
        <div class="md:col-span-12 flex justify-end">
            <a th:href="@{|/admin/export/xlsx?q=${q}&type=${type}&status=${status}&start=${start}&end=${end}&dir=${dir}|}"
               class="rounded-xl ring-1 ring-brand/15 px-5 py-2 text-center hover:bg-brand/5 transition">
                엑셀다운
            </a>
        </div>
    </form>

    <div class="mb-3 grid grid-cols-2 md:grid-cols-4 gap-2">
        <div class="rounded-xl bg-white ring-1 ring-brand/10 px-4 py-3">
            <div class="text-xs text-brand/60">총 신청 인원 수</div>
            <div class="text-lg font-semibold" th:text="${totalApplicants}">0</div>
        </div>
        <!-- 원하면 더 추가: 총 응모건수, 취소건수 등 -->
    </div>
    <div class="overflow-x-auto rounded-xl ring-1 ring-brand/10">
        <table class="min-w-full text-sm table-auto">
            <thead class="bg-gray-50 text-brand/80">
            <tr>
                <th class="px-4 py-3 text-left whitespace-nowrap min-w-[140px]">생성시각</th>
                <th class="px-4 py-3 text-left whitespace-nowrap min-w-[180px]">ID</th>
                <th class="px-4 py-3 text-left whitespace-nowrap min-w-[120px]">유형</th>
                <th class="px-4 py-3 text-left whitespace-nowrap min-w-[120px]">연주자</th>
                <th class="px-4 py-3 text-left whitespace-nowrap min-w-[90px]">상태</th>
                <th class="px-4 py-3 text-center whitespace-nowrap min-w-[70px]">인원</th>
                <th class="px-4 py-3 text-center whitespace-nowrap min-w-[90px]">대표수령</th>
                <th class="px-4 py-3 text-left whitespace-nowrap min-w-[220px]">대표수령자</th>
                <th class="px-4 py-3 text-center whitespace-nowrap min-w-[110px]">액션</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="a : ${page.content}" class="border-t">
                <td class="px-3 py-2" th:text="${#temporals.format(a.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                <td class="px-3 py-2">
                    <a th:href="@{'/admin/applications/' + ${a.applicationId}}" class="underline"
                       th:text="${#strings.abbreviate(a.applicationId.toString(), 15)}"></a>
                </td>
                <td class="px-3 py-2" th:text="${a.domainType.ko()}"></td>
                <td class="px-3 py-2" th:text="${a.performer==null?'':a.performer.name}"></td>
                <td class="px-3 py-2" th:text="${a.status.ko()}"></td>
                <td class="px-3 py-2 text-center" th:text="${a.totalCount}"></td>
                <!-- ✅ 대표수령여부 -->
                <td class="px-3 py-2 text-center">
                    <span th:if="${a.repDelivery}" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-green-50 ring-1 ring-green-200 text-green-700">✓</span>
                    <span th:if="${!a.repDelivery}" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-50 ring-1 ring-gray-200 text-gray-500">–</span>
                </td>
                <td class="px-3 py-2">
                    <div th:text="${a.repName}"></div>
                    <div class="text-xs text-brand/60" th:text="${a.repEmail}"></div>
                    <div class="text-xs text-brand/60" th:text="${a.repPhone}"></div>
                </td>
                <td class="px-3 py-2 text-center">
                    <form th:if="${a.status.name() != 'CANCELED'}"
                          th:action="@{'/admin/applications/' + ${a.applicationId} + '/cancel'}" method="post"
                          onsubmit="return confirm('해당 응모를 취소할까요?');">
                        <button class="px-3 py-1 rounded-lg ring-1 ring-red-200 text-red-700 hover:bg-red-50">취소</button>
                    </form>
                    <span th:if="${a.status.name() == 'CANCELED'}" class="text-brand/50">-</span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 페이지네이션 -->
    <div class="mt-4 flex items-center justify-center gap-2 text-sm">
        <a th:if="${!page.first}" th:href="@{/admin(page=${page.number-1}, size=${page.size}, q=${q}, type=${type}, status=${status})}"
           class="px-3 py-1 rounded ring-1 ring-brand/15">이전</a>
        <span th:text="${page.number+1} + ' / ' + ${page.totalPages}"></span>
        <a th:if="${!page.last}" th:href="@{/admin(page=${page.number+1}, size=${page.size}, q=${q}, type=${type}, status=${status})}"
           class="px-3 py-1 rounded ring-1 ring-brand/15">다음</a>
    </div>
</section>
</body>
</html>
