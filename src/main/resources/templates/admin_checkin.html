<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" th:replace="fragments :: layout(~{::body})">
<body>
<section>
    <h2 class="text-2xl font-semibold text-brand mb-3">현장 체크인</h2>

    <div class="flex items-center gap-2 mb-3">
        <select id="cameraSel" class="rounded-lg ring-1 ring-black/10 px-3 py-2 min-w-[200px] hidden"></select>
        <button id="startBtn" class="px-3 py-2 rounded-lg bg-brand text-white">카메라 시작</button>
        <button id="stopBtn"  class="px-3 py-2 rounded-lg ring-1 ring-black/10 hidden">중지</button>
    </div>

    <div id="reader" class="rounded-xl overflow-hidden ring-1 ring-black/10 w-full max-w-md aspect-square bg-black/5"></div>

    <!-- 결과/정보 표시 -->
    <div id="panel" class="mt-4"></div>

    <!-- 폴백: 이미지 업로드 -->
    <div class="mt-4 lib-card p-4">
        <div class="text-sm text-brand/80 mb-2">이미지로 스캔(폴백)</div>
        <input id="fileInput" type="file" accept="image/*" class="text-sm">
    </div>
</section>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    const cameraSel = document.getElementById('cameraSel');
    const startBtn  = document.getElementById('startBtn');
    const stopBtn   = document.getElementById('stopBtn');
    const fileInput = document.getElementById('fileInput');
    const panel     = document.getElementById('panel');

    let qr, currentCamId=null, running=false, lastToken=null;

    function infoCard(data, token){
      // data: {code,message,name,email,phone,issuedAt,usedAt}
      const statusClass =
        data.code==='USED' ? 'bg-yellow-50 ring-1 ring-yellow-200 text-yellow-800' :
        data.code==='CANCELLED' ? 'bg-red-50 ring-1 ring-red-200 text-red-700' :
        data.code==='NOT_FOUND' ? 'bg-red-50 ring-1 ring-red-200 text-red-700' :
        'bg-emerald-50 ring-1 ring-emerald-200 text-emerald-800';

      const usedInfo = data.usedAt ? `<div><span class="text-brand/60">사용일:</span> ${data.usedAt}</div>` : '';
      const actionBtn =
        data.code==='ISSUED'
          ? `<button id="confirmUse" class="mt-3 px-4 py-2 rounded-lg bg-brand text-white">사용 처리</button>`
          : `<button id="closePanel" class="mt-3 px-4 py-2 rounded-lg ring-1 ring-black/10">닫기</button>`;

      panel.innerHTML = `
        <div class="rounded-xl p-4 ${statusClass}">
          <div class="text-sm mb-2">상태: <b>${data.message}</b></div>
          <div class="bg-white/70 rounded-lg p-3 text-black">
            <div><span class="text-brand/60">이름:</span> ${data.name ?? '-'}</div>
            <div><span class="text-brand/60">이메일:</span> ${data.email ?? '-'}</div>
            <div><span class="text-brand/60">전화번호:</span> ${data.phone ?? '-'}</div>
            <div><span class="text-brand/60">발급일:</span> ${data.issuedAt ?? '-'}</div>
            ${usedInfo}
          </div>
          ${actionBtn}
        </div>
      `;

      if(data.code==='ISSUED'){
        document.getElementById('confirmUse').onclick = async ()=>{
          try{
            const r = await fetch(`/admin/checkin/${token}`, { method:'POST' });
            const txt = await r.text();
            if(txt==='OK'){
              panel.innerHTML = `<div class="rounded-xl p-3 bg-emerald-50 ring-1 ring-emerald-200 text-emerald-800">사용 처리 완료</div>`;
              // 잠깐 표시 후 다시 스캔 재개
              setTimeout(()=>{ panel.innerHTML=''; resume(); }, 800);
            }else if(txt==='ALREADY'){
              panel.innerHTML = `<div class="rounded-xl p-3 bg-yellow-50 ring-1 ring-yellow-200 text-yellow-800">이미 사용된 티켓입니다.</div>`;
              setTimeout(()=>{ panel.innerHTML=''; resume(); }, 1200);
            }else if(txt==='CANCELLED'){
              panel.innerHTML = `<div class="rounded-xl p-3 bg-red-50 ring-1 ring-red-200 text-red-700">취소된 티켓입니다.</div>`;
              setTimeout(()=>{ panel.innerHTML=''; resume(); }, 1200);
            }else{
              panel.innerHTML = `<div class="rounded-xl p-3 bg-red-50 ring-1 ring-red-200 text-red-700">유효하지 않은 티켓</div>`;
              setTimeout(()=>{ panel.innerHTML=''; resume(); }, 1200);
            }
          }catch(e){
            panel.innerHTML = `<div class="rounded-xl p-3 bg-red-50 ring-1 ring-red-200 text-red-700">처리 실패: ${e}</div>`;
            setTimeout(()=>{ panel.innerHTML=''; resume(); }, 1200);
          }
        };
      }else{
        document.getElementById('closePanel').onclick = ()=>{ panel.innerHTML=''; resume(); };
      }
    }

    function extractToken(decodedText){
      try{
        const u = new URL(decodedText, location.origin);
        const m = u.pathname.match(/\/t\/([A-Za-z0-9]+)/);
        if(m) return m[1];
      }catch(e){
        const m = decodedText.match(/\/t\/([A-Za-z0-9]+)/);
        if(m) return m[1];
      }
      if(/^[A-Za-z0-9]+$/.test(decodedText)) return decodedText;
      return null;
    }

    async function fetchInfo(token){
      const r = await fetch(`/admin/checkin/ticket/${token}`);
      if(r.status===404){
        return { code:'NOT_FOUND', message:'유효하지 않은 티켓입니다.' };
      }
      return await r.json();
    }

    async function onDecoded(text){
      const token = extractToken(text);
      if(!token) return;
      lastToken = token;
      await pause();
      const data = await fetchInfo(token);
      infoCard(data, token);
    }

    async function initCameras(){
      try{
        const devs = await Html5Qrcode.getCameras();
        if(!devs || devs.length===0){
          cameraSel.classList.add('hidden');
          panel.innerHTML = `<div class="rounded-xl p-3 bg-slate-50 ring-1 ring-black/10 text-slate-700">카메라 없음: 아래 ‘이미지로 스캔’을 사용하세요.</div>`;
          return;
        }
        let idx = devs.findIndex(d => /back|rear|environment/i.test(d.label));
        if(idx<0) idx=0;
        currentCamId = devs[idx].id;

        cameraSel.innerHTML = devs.map(d=>`<option value="${d.id}">${d.label||'Camera'}</option>`).join('');
        cameraSel.value = currentCamId;
        cameraSel.classList.remove('hidden');

        await start(currentCamId);
      }catch(e){
        panel.innerHTML = `<div class="rounded-xl p-3 bg-yellow-50 ring-1 ring-yellow-200 text-yellow-800">카메라 접근 실패: 브라우저 권한을 허용해 주세요.</div>`;
        console.error(e);
      }
    }

    async function start(camId){
      if(!qr) qr = new Html5Qrcode("reader", { verbose:false });
      await qr.start(
        { deviceId: { exact: camId } },
        { fps:10, qrbox:{width:240,height:240} },
        onDecoded,
        (err)=>{} // 디코드 실패는 무시
      );
      running = true;
      startBtn.classList.add('hidden');
      stopBtn.classList.remove('hidden');
    }
    async function pause(){
      if(qr && running){
        await qr.stop();
        running = false;
        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
      }
    }
    async function resume(){
      if(currentCamId) await start(currentCamId);
    }
    async function stop(){
      if(qr && running){
        await qr.stop();
        await qr.clear();
        running = false;
        startBtn.classList.remove('hidden');
        stopBtn.classList.add('hidden');
      }
    }

    // 이벤트
    startBtn.onclick = async ()=>{ if(currentCamId) await start(currentCamId); else await initCameras(); };
    stopBtn.onclick  = stop;
    cameraSel.onchange = async (e)=>{ currentCamId = e.target.value; await pause(); await start(currentCamId); };

    // 폴백 파일 스캔
    fileInput.onchange = async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      try{
        if(!qr) qr = new Html5Qrcode("reader", { verbose:false });
        const text = await qr.scanFile(f, true);
        await onDecoded(text);
      }catch(err){
        panel.innerHTML = `<div class="rounded-xl p-3 bg-red-50 ring-1 ring-red-200 text-red-700">이미지 인식 실패</div>`;
        console.error(err);
      }
    };

    // 초기화
    initCameras();
</script>
</body>
</html>
